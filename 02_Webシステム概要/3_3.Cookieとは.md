# Cookieとは 

## なにこれ
業務アプリを作るうえでは必須の知識である「Cookie」について解説します。  


## Cookieとは  
Cookieとは、Webサーバーからブラウザに対して送信され、ブラウザ内で保存される小さな文字列データのことです。
ブラウザは次回以降同じWebサーバーにリクエストを送る際、保存されたCookieを自動的にHTTPヘッダーに記載します。  

Cookieをやり取りする手順は以下になります。  


1. ブラウザからWebサーバーにHTTPリクエストが送信されます。  
Cookieが付与されていない状態の最初のリクエストです。   
<img src="画像/Cookieとは_手順1.png" style="width:360px;">  

1. WebサーバーからCookieが返却されます。  
Cookieはレスポンスヘッダーに記載されます。    
<img src="画像/Cookieとは_手順2.png" style="width:480px;">  

1. ブラウザはレスポンスヘッダーのCookieを内部で保持します。  
それ以降同じWebサーバーへのリクエストを送信する際、リクエストヘッダーに自動的にCookieの値が記載されます。  
**同じWebサーバーかは、URLのホスト名が同一かで判断します。**  
<img src="画像/Cookieとは_手順3.png" style="width:480px;">   



## リクエスト・レスポンスヘッダーへの記述ルール
上で説明した通り、Cookieはレスポンス・リクエストメッセージのヘッダーでやりとりされます。  

### レスポンスヘッダー
Webサーバーから返却されるCookieはレスポンスヘッダーに記述されます。  
ヘッダーは`set-cookie: Cookie名=値`という形式で値を指定します。  
`set-cookie`ヘッダーは複数指定可能です。  

例  

```http
HTTP/2.0 200 OK  
content-type: text/html  
set-cookie: my_cookie1=aaaaa  
set-cookie: my_cookie2=bbbbb  
```

set-cookieヘッダーが返ってくると、ブラウザはリクエストを送信したサーバーと、cookie情報を紐付けて保存します。  
2度目以降のレスポンスで同じCookie名が返ってきた場合は保存している情報を上書きします。  


### リクエストヘッダー
以降、同じホスト名のURLにリクエストを送信する際、Cookieはリクエストヘッダーに記述されます。  
ヘッダーは`Cookie: Cookie名=値`という形式で指定します。   
`set-cookie`ヘッダーと違いヘッダーの複数指定は出来ず、複数のCookieを送る場合は`;`（セミコロン）で区切って1行に記載します。  

例  

```http
GET /sample_page.html HTTP/2.0
host: www.example.org
Cookie: my_cookie1=aaaaa; my_cookie2=bbbbb
```

### Cookieの属性
レスポンスヘッダーでCookieを返却する際、いくつかの属性を指定する事が可能です。  
属性はCookieの後ろに`;`で区切って指定します。  

`set-cookie: Cookie名=値;属性名=属性値;属性名=属性値;・・`

#### Cookieの有効期限  
Cookieの保存期限を指定することが可能です。  

有効期限を指定できる属性は`Expires`と`Max-Age`の２つがあり、両方指定された場合は`Max-Age`が優先されます。  

- Expiresの例  
いつまで有効とするか日時を指定します。  
   ```http
   Set-Cookie: my_cookie1=aaaaa; Expires=Thu, 31 Oct 2022    07:28:00 GMT;
   ``` 
- Max-Ageの例  
いつまで有効かを秒数で指定します。  
   ```http
   Set-Cookie: my_cookie1=aaaaa; Max-Age=3600;
   ``` 

有効期限が指定されていないものは、ブラウザを閉じると削除されます。  
指定されていればローカルディスクに保存され、ブラウザを閉じても削除されません。  
ブラウザは有効期限が切れていないCookieのみを送信します。  

Webサイトを利用する際、ブラウザを閉じるとログアウトしてる場合や、ブラウザを閉じてもログインが継続している場合があると思います。  
この動作の違いはCookieの有効期限の違いにより起こっていることが多いです。  
(後述しますがログイン状態をCookieに記録することが多いです。)  

#### Cookieのセキュリティ属性
セキュリティの為の属性も指定できます。  
- Secure属性  
この属性を指定すると、HTTPS通信の場合のみCookieが送信されます。  
Secure属性には値は不要です。  
   ```http
   Set-Cookie: my_cookie1=aaaaa; Secure
   ``` 
- HttpOnly属性  
JavascriptにはCookieを操作するAPIがあるのですが、この属性を指定すると、JavascriptからCookieにアクセス出来なくなります。  
Secure属性と同様、値は不要です。  
   ```http
   Set-Cookie: my_cookie1=aaaaa; HttpOnly
   ``` 

- Same-Site属性  
リクエストの送信元ドメインと送信先ドメインが異なる場合の動作を制御します。  
例えば、http\:\/\/**domainA**.comというURLで開いたページから、http\:\/\/**domainB**.comというURLにリクエストを送信する場合です。  
以下の値を指定できます。  
  - None  
  ドメインが異なっていてもCookieを送信する。    
  - Lax  
  Getリクエストの場合のみCookieを送信する。  
  - Strict  
  ドメインが異なっていてもCookieを送信しない。  
   ```http
   Set-Cookie: my_cookie1=aaaaa; Same-site=Lax;
   ``` 
   この設定はリクエストされる側（例だと**domainB**側）のcookieに指定します。  

- domain属性  
Cookieを送信するドメインを指定します。   
指定したドメインへのリクエストの場合だけCookieが設定されます。   
省略した場合はCookieを取得したURLのドメインが設定されます。  
それで十分なことが多い為、**基本的に省略されます。**  
またdomain属性を指定した場合、そのサブドメインへのリクエスト時にもCookieが送信されます。  
省略した場合サブドメインへは送信されません。  
[参考](https://blog.tokumaru.org/2011/10/cookiedomain.html)

## Cookieの利点
ブラウザが自動的にCookieを送信してくれるため、Cookieに記載した値について、クライアント側でパラメータを設定する実装が不要になることです。  

その為、常に送信したいパラメータはCookieを利用する事が多いです。  

## Cookieの問題点
Cookieには以下の問題点があります。  

- Cookieの値がローカルディスクに保存されるため、機密情報が個人情報が含まれる場合セキュリティ的に問題がある。  
- 1つのCookie当たりのサイズに制限がある為、長いパラメータを送れない。  
(ブラウザにもよりますが、4096バイトくらいが制限です。)
- Cookie数が増えるとリクエストのサイズが増大していく。  
- 配列やネストしたデータを表現しにくい。  


## Cookieの主な用途
Cookieは主に以下の用途で利用されます。  

- キー文字列  
セッションIDや、認証済みであることを表す認証IDなどのキー文字列の受け渡しに利用されます。  
セッションについては[別記事](3_4.セッションとは.md)で解説します。  

- アクセス解析・ユーザー分析  
セッション数やページ遷移などを分析する為の情報の受け渡しに利用される場合があります。    

基本的には、常に送信したパラメータの受け渡しによく利用されます。  

## ブラウザタブとCookie
Cookieはタブごとに保存されているのではなく、ブラウザ自体に保存されます。  
あるタブで取得したCookieは、別のタブでリクエストを発行する場合も添付されます。  

<img src="画像/Cookieとは_タブとの関係.png" style="width:640px;">   

## Cookieの確認方法
ブラウザの開発者ツールからCookieを確認可能です。  
Chromeだと、F12で開く開発者ツールの「Netword」タブで各リクエスト・レスポンスに付与されるCookieを確認できます。  
<img src="画像/Cookieとは_開発者ツール1.png" style="width:640px;">   


また、「Application」タブの「Cookies」タブから、ブラウザに保存されているCookieを確認可能です。  
<img src="画像/Cookieとは_開発者ツール2.png" style="width:380px;">   

## Cookieの仕様
CookieはHTTPの仕様の一部として定義されています。  

[仕様文書](https://triple-underscore.github.io/http-cookie-ja.html)

## 参考

[MDN Cookieとは](https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies)

