# Cookieとセッション  

## なにこれ
業務アプリを作るうえでは必須の知識である「Cookie」や「セッション」について解説します。  

## HTTPはステートレスなプロトコル    
HTTPはステートレスなプロトコルと呼ばれています。  
ステートレスというのは、１つのリクエスト・レスポンスで処理が完結しており、前後のリクエスト間で関連が無いことです。  

この特性のおかげでHTTPはシンプルなプロトコルとなったのですが、実際に使う際には困ることがあります。  

例えばECサイトなどで以下の処理をする場合です。  

1. 商品Aをカートに入れる  
（カート一覧画面に商品Aが表示される）  

1. 商品Bをカートに入れる  
（カート一覧画面に商品Aと商品Bが表示される）  

1. 注文する  
（商品Aと商品Bの注文が完了した旨が表示される）  

前述したとおり、各リクエストは単独で完結しており前後のリクエストとは関連しません。  
（前のリクエストの情報を覚えてません）  

その為、これを実現する為にはリクエストの度に全ての情報を送らなくてはいけません。  
以下のようなイメージです。  

1. 商品Aをカートに入れる  

1. 商品Aと商品Bをカートに入れる  

1. 商品Aと商品Bをカートに入れて注文する  


このような場合に対応する方法の１つとして、HTTPにはCookieという仕組みが用意されています。  


## Cookieとは  
Cookieとは、Webサーバーからブラウザに対して送信され、ブラウザ内で保存される文字列データのことです。
ブラウザは以降同じWebサーバーにリクエストを送る際、保存されたCookieを自動的にHTTPヘッダーに記載します。  

Cookieをやり取りする手順は以下になります。  

1. ブラウザからWebサーバーにHTTPリクエストが送信される。  
Cookieが付与されていない状態の最初のリクエストです。   

  図 

1. WebサーバーからCookieが返却される。Cookieはレスポンスヘッダーに記載される。  
  図 

1. ブラウザはレスポンスヘッダーのCookieを内部で保持する。
  図 

1. それ以降、同じWebサーバーへのリクエストを送信する際、リクエストヘッダーにCookieの値が記載される。  
同じWebサーバーかは、URLのプロトコル・ホスト名・ポートが全て同一かで判断します。  
  
図  

HTTPレスポンスにてクライアントにCookieを送信します。  
するとそれ以降、ブラウザは同じWebサーバーにリクエストする際、そのCookieを自動的にリクエスに含んで送信します。  
(同じWebサーバーかはURLのホスト名で判断します。)  

図  


### Cookieのリクエスト・レスポンスヘッダー

#### レスポンスヘッダー
Webサーバーから返却されるCookieはレスポンスヘッダーに記述されます。  
ヘッダー名は`set-cookie`で、`Cookie名=値`という形式で値を指定します。  
`set-cookie`ヘッダーは複数指定可能です。  


例  

```
HTTP/2.0 200 OK  
content-type: text/html  
Set-Cookie: my_cookie1=aaaaa  
Set-Cookie: my_cookie2=bbbbb  
```

このレスポンスが返ってくると、ブラウザはリクエストを送信したドメインと、cookie情報を保存します。  
2度目以降のレスポンスで同じCookie名が返ってきた場合は保存している情報を上書きします。  


#### Cookieの有効期限  
WebサーバーからCookieを送信する際に、Cookieの有効期限を指定することも可能です。   

```
Set-Cookie: my_cookie1=aaaaa; Expires=Thu, 31 Oct 2022 07:28:00 GMT;
``` 
有効期限が指定されていないものは、ブラウザを閉じると削除されます。  
指定されていればローカルディスクに保存され、ブラウザを閉じても削除されません。  
ブラウザは有効期限が切れていないCookieのみを送信します。  

Webサイトを利用する際、ブラウザを閉じるとログアウトしてる場合や、ブラウザを閉じてもログインが継続している場合があると思います。  
(後述しますがログイン状態をCookieに記録することが多いです。)  
この動作の違いはCookieの有効期限の違いにより起こっていることが多いです。  


### リクエストヘッダー
ブラウザから送信するCookieはリクエストヘッダーに記述されます。  
ヘッダー名は`Cookie`で、`Cookie名=値`という形式で値を指定します。   
複数送る場合はセミコロン`;`で区切って記載します。  

例  

```
GET /sample_page.html HTTP/2.0
host: www.example.org
Cookie: my_cookie1=aaaaa; my_cookie2=bbbbb
```
図  

### Cookieの利点
ブラウザが自動的にCookieを送信してくれるため、Cookieに記載した値について開発者側で値を受け渡す処理を実装しなくてよくなることです。

例えば、最初の例でCookieを用いると、以下のように処理出来ます。  
（後述しますが、色々な問題がある為、実際にはこのような使い方をすることはありません。あくまで動作イメージをつかむためのものと思ってください。）  

1. 商品Aをカートに入れる  

リクエスト 
``` 
POST /cart/A HTTP/2.0
host: www.example.org
```

レスポンス  
```
HTTP/2.0 200 OK
Set-Cookie: cart_item1=A  
```


1. 商品Bをカートに入れる  

リクエスト 
``` 
POST /cart/B HTTP/2.0
host: www.example.org
Cookie: cart_item1=A
```

レスポンス  
```
HTTP/2.0 200 OK
Set-Cookie: cart_item2=B  
```

1. 注文する  

リクエスト 
``` 
POST /order HTTP/2.0
host: www.example.org
Cookie: cart_item1=A; cart_item2=B
```

レスポンス  
```
HTTP/2.0 200 OK
```

図  


ブラウザが自動的にCookieを送信してくれるため、クライアント側でパラメータを設定するような実装は不要になります。  

### Cookieの問題点
ただ、このようなCookieの利用方法には以下の問題があります。  

- Cookieの値がローカルディスクに保存されるため、機密情報が個人情報が含まれたデータをやり取りするのはセキュリティ的に問題がある。  
- Cookieが増えるとリクエストのサイズが増大していく。  
- 記述できる文字数に制限があるため、長いパラメータを送らない。
- 記述方法に制限があり、配列などのデータを表現しにくい。  


このようなデメリットがある為、リクエスト間で値の受け渡す為には別の方法を利用する必要があります。
それが**セッション**と言う仕組みです。  

## セッション
セッションとは簡単に説明すると、「サーバ内にデータを保存し、リクエスト間で共有する」仕組みのことです。  
サーバ内にデータを保存し、クライアントにその情報にアクセスする為のキーを渡します。

セッションはWebアプリライブラリ（Java Servletなど）が持っている機能で、Cookieとは別の仕組みです。 
ただセッションの仕組みの一部として、Cookieを利用することが多いです。  
（上述したサーバ内に保存したデータにアクセスするためのキーをCookieで受け渡すことが多いです。）  

### セッションの処理の流れ  
大まかな処理の流れは以下になります。  

1. （サーバー）最初にリクエストが来た時に、データを保存する領域を確保  
（以下セッション情報と呼びます）

1. （サーバー）その情報にアクセスするためのキーを作成し、HTTPレスポンスで返却  
このキーを**セッションID**と呼びます。  
このセッションIDを返却する際にcookieを利用します。  
(他にも返却方法はありますが、広く使われているのはcookieを利用する方法です。)  

1. （クライアント）2度目以降のリクエストでセッションIDを送信  
Cookieを利用していればブラウザが自動でリクエストヘッダーを追加してくれます。  

1. （サーバー）セッションIDに対応するセッション情報にアクセス可能となる。  
必要に応じてセッションにデータを保存したり、取り出したりします。  
セッションをどう使うかはWebアプリの実装次第となります。  

図  

### よくある使い方
ログインしたユーザーの情報などを保管することが多いです。  
例えば以下のような処理を行います。  

1. ログイン時のリクエストで、ID、passwordが正しければセッションにログインしたユーザーの情報を保存  
1. 以降のリクエスト（例えばマイページの表示）では、セッションからユーザー情報を取り出し、それをもとにページを表示  

この場合、セッションにユーザー情報が登録されているかをログイン済みかの判定に用いることもあります。
（セッションにユーザー情報が登録されていいなければ未ログインと判定し、エラーなりログイン画面にリダイレクトさせるなりの処理を行います。）  



図  

ただし、この方法だけでログイン判定すると以下の脆弱性があります。

その為、他の方法と組み合わせて認証を行う必要があります。  
詳しくはセキュリティについての記事で説明します。  


### セッション情報の保存先
セッション情報は主に以下に保存されます。  

- サーバーのメモリ  
- DB  
- DB以外の高速なデータストア(Redisなど)  

サーバーのメモリが一番手軽ですが、サーバーを（負荷分散の為などで）複数台構成にした場合に同期がとれません。  
またサーバーアプリを再起動した場合にセッション情報がクリアされてしまいます。  

その為、DBなどのAppサーバー外にセッション情報を保持する事も多いです。  
ただセッション情報は頻繁にアクセスされる事が多いため、DBよりも処理が高速なデータストア(Redisなど)が利用されることも多いです。  



### セッション情報の持ち方
セッションはセッションIDをキーにしたキーバリュー型の変数に保存されるイメージです。  
（JavaのmapやC#のDictionary的なもの）
これはWebアプリのフレームワークやライブラリによって管理されています。  

図  


セッションIDはそれぞれのクライアント毎に発行される事になるので、別のクライアントのセッション情報が見れてしまうことはありません。  

図  

セッションIDは既に使用済みのキーとは重複せず、かつ推測出来ないような十分な長さの文字列出なくてはいけません。  
主要なWebシステムのライブラリにはそのようなセッションキーを作成する為の関数が用意されており、自動で生成してくれます。  


それぞれのセッションID毎に保存するデータの形式は様々です。  
これはデータの保存先によって保存可能なデータがことなります。  

- メモリ上の場合
プログラムで利用している変数などをそのまま保存できます。  

文字列を保存する

そしてその変数を、システムが用意しているセッション全体を管理する為のさらに大きなキーバリュー型の変数に設定します。  
(システムが用意した1つの大きなキーバリュー型の入れ物に、各セッション情報を保持するキーバリュー側の入れ物を設定するイメージです。)  


### セッションを利用するサーバー側のコード例

セッション全体を管理する領域からセッションIDに対応するセッション情報を取得する処理は、フレームワーク側でやってくれることが多いです。  

それを利用する場合は以下のようなコードを記述します。  
```


```



### セッションの有効期限
セッションの有効期限には２つの側面があります。  

- サーバーのセッション変数の有効期限

- クライアントに返却したセッションIDのCookieの有効期限  

この２つの情報のいずれかが欠けると、いままでセッションに保存したデータが利用できなくなります。  
（新しいセッションとして認識されます。）  

Cookieの有効期限を長くしても、サーバー側のセッション情報が無くなった場合（メモリ上に保持しているケースでサーバーを再起動した場合など）は、そのセッションは利用できなくなります。  

またサーバー側のセッション情報が残っていても、セッションIDのCookieの有効期限が切れていると、セッションIDが送られてこない為そのセッション情報にアクセスすることが出来なくなります。 


これらの場合新しい空のセッション情報が作成され、新しいセッションIDが返却されることになります。  



### 最初の例でセッションを使うと

最初の例でセッションを使うと以下のような処理になります。  

1. 商品Aをカートに入れる  

リクエスト 
``` 
POST /cart/A HTTP/2.0
host: www.example.org
```

サーバー側コード  
```


```

レスポンス  
```
HTTP/2.0 200 OK
Set-Cookie: SESSION_ID=KJfdafdfadDFJIa  
```


1. 商品Bをカートに入れる  

リクエスト 
``` 
POST /cart/B HTTP/2.0
host: www.example.org
Cookie: SESSION_ID=KJfdafdfadDFJIa  
```

サーバー側コード  
```


```

レスポンス  
```
HTTP/2.0 200 OK
```

1. 注文する  

リクエスト 
``` 
POST /order HTTP/2.0
host: www.example.org
Cookie: SESSION_ID=KJfdafdfadDFJIa 
```

サーバー側コード  
```


```

レスポンス  
```
HTTP/2.0 200 OK
```

図  



###　セッションの仕様
セッションの仕組みは標準化団体に定義されたものではなく、各Webアプリのライブラリが実装しているものです。
ただよく使われる機能であり、ほとんどのWebアプリライブラリで同じ仕組みで利用できます。  



## Cookieの主な用途
Cookieの話に戻ると、CookieはセッションIDなどのキー情報をやり取りする為に使うことが多いです。    

キー情報として良くやり取りされるものは以下になります。  
- セッションID
- 認証ID  
(認証済みであることを表す文字列)



## ブラウザタブとCookieの関係
Cookieはタブごとに保存されているのではなく、ブラウザ自体に保存されます。  
あるタブで取得したCookieは、別のタブでリクエストを発行する場合も添付されます。  

図  

## 参考




