# Webサーバーへのパラメータの渡し方

## なにこれ？
ユーザーの入力値などのパラメータをサーバーに渡したいことがよくあります。  
（例えばユーザー登録画面で入力されたユーザー名や住所などを送りたい など） 

その際はリクエストメッセージにパラメータ情報を含めるのですが、いくつか方法があります。  

## Webサーバーへのパラメータの渡し方

Webサーバーへパラメータを送信する際、主に使われる方法は以下になります。  

- クエリストリングで送信
- フォームデータで送信
- リクエストボディにJsonで記載し送信
- リクエストヘッダーで送信

以下それぞれについて説明していきます。  

### クエリストリングで送信 
URLの末尾の`?`以降の文字列を**クエリ文字列**または**クエリストリング**といいます。  
ここにパラメータを記載します。   
例  
```
http://example.com/?name=yamada&address=hokkaido
```
この場合、`name=yamada&address=hokkaido`の部分がクエリストリングになります。  
パラメータは`キー=値`の形式で記載し、複数ある場合は`&`で連結します。  

この方法はGETメソッドでリクエストする際に用いられます。  
formタグのmethod属性にGETが指定されていた場合、formタグ内のinputタグなどの入力値が、submit時にクエリストリングに記載されます。  

####  メリット  
  - URLだけでパラメータ情報を伝えることが出来る  
  URL自体にパラメータ情報が含まれる為、URLをコピーして別タブ・別ブラウザで開いた場合や、お気に入りから再度開いた際も同じパラメータを渡すことが出来ます。  
   
#### デメリット  
  - URLの文字数制限  
  ブラウザによってはURLの文字数の最大値が決まっている為、長いパラメータを渡すことが出来無い場合があります。  
  (IEが2083文字、Safariが4096文字、その他はほぼ制限なし。  
  IEのサポートが切れた後は、Safariの4096が基準になるかと思います。)    
  
  - セキュリティ  
  URLにパラメータが表示されてしまうため、個人情報や機密情報（パスワードなど）のパラメータがある場合セキュリティ的に問題があります。  
  お気に入り登録するとパラメータ込みのURLが平文で保存されてしまいます。  
  またWebサーバー側でアクセスログを記録している場合、大抵のサーバーアプリはリクエストのURLを記録するため、ログ上に機密情報が書き込まれてしまいます。    


### フォームデータの送信で送信
リクエストボディにフォームデータ形式で記述します。     
フォームデータは、`キー=値`形式で記載され、複数ある場合は`&`で連結されます。  

例
```http
POST / HTTP/1.1
host: example.com
content-type: application/x-www-form-urlencoded
content-length: 69

name=yamada&address=hokkaido
```

リクエストヘッダーの`content-type`は`application/x-www-form-urlencoded`になります。  

formタグのmethod属性でPOSTを指定しフォームをサブミットした場合、formタグ内のフォームコントロールの値がフォームデータ形式でリクエストボディに記載されます。  
フォームデータの送信については[別記事](2_1.ブラウザがHTTPリクエストを送るタイミング.md#フォームデータの送信時)で解説しています。  
   
#### メリット  
- 文字数制限がない  
クエリストリングとは異なり、リクエストボディには文字数の制限がありません。  

- URLだけではパラメータを渡せない  
URLにパラメータが含まれない為、同じURLを後で開いても同じ処理は行えません。  
その為、再度リクエストを送られたくないURLによく利用されます。  
（登録、削除などのデータ変更処理を伴うURLなど）  

- セキュリティ（がクエリストリングよりはよい）  
URLにパラメータが含まれない為、URLをブックマークされてもパラメータが保存されません。  
またWebサーバー側でログ出力する際、リクエストボディまでは出力しない場合が多いです。  
その為、クエリストリングよりはパラメータが人目につく確率は低いです。  
(とはいえ完璧に隠ぺいできるわけではないので、あくまで比較するとましであるというだけです。)    
   
####  デメリット  
- ブックマークなどから再度同じ処理を行えない  
メリットの項でも述べましたが、URLにパラメータが含まれない為、ブックマークされたURLを後で開いても同じ処理は行えません。  
そのため、参照系の画面でブックマークから再度開いてもらいたい場合は使えません。  


Javascriptを使わずにブラウザからリクエストが発行される場合は、上記2つのいずれかの方法でパラメータを渡すことになります。  

### リクエストボディにJson形式で記載し送信  
JavascriptなどでHTTPリクエストを作って発行する際は、パラメータを自由に記述することが出来ます。  
クエリストリングで渡すことも出来ますし、リクエストボディにフォームデータ形式以外の形式でパラメータを含めることも出来ます。  

ただよく使われるのは、Jsonの文字列をリクエストボディに含める方法です。  
以下のようなリクエストを発行します。   
```http
POST / HTTP/1.1
host: example.com
content-type: application/json
content-length: 24

{"name":"yamada", "address":"hokkaido"}
```

Javascriptなどのプログラム言語では以下の手順でリクエストを作成します。  
1. 送信したい値をもったJavascriptのオブジェクトを作成


1. そのオブジェクトをJson文字列に変換  
大半の言語には、オブジェクトをJson文字列にしたり、Json文字列からオブジェクトを作る為のライブラリが存在します。  
Javascriptでは標準の関数として用意されています。  

1. Json文字列をリクエストボディに記載して送信。  
     
javascriptのFetch関数を利用した例  
```js
//送信したい値をもったJavascriptのオブジェクト
const data = {name: "yamada", address: "hokkaido"};

//fetch関数を利用してサーバーにリクエストを送信
const response = await fetch('http://example.com', {
    method: 'POST', 
    headers: {'content-type': 'application/json'}, 

    body: JSON.stringify(data) // JavascriptのオブジェクトをJson文字列に変換してボディに設定
 })
 const result = await response.json(); 
```

#### メリット  
 - 複雑なデータを表現しやすい  
Jsonは配列やネストしたデータを表現できるため、複雑な構造のデータを送るのが容易です。   

- プログラムから利用しやすい  
主要なプログラミング言語にはJson文字列⇔その言語のオブジェクトを変換するライブラリが存在します。  


#### デメリット  
-  サーバー側にもJsonの変換処理が必要  
サーバー側でも、リクエストから取り出したJson文字列をサーバー側言語のオブジェクトに変換する処理が必要です。  
ただ上で説明した通り、Json用のライブラリはほとんどの言語に用意されている為、そこまで難しいことではありません。  

サーバー側でWebフレームワークを使っている場合、Jsonとオブジェクトの変換処理を自動で行ってくれる事が多いです。  
（この場合変換するコードを書かなくて良いのですが、そのWebフレームワークのルールは把握しておく必要があります。  
たとえば、リクエストヘッダーに`content-type: application/json`を指定しないと自動変換しない、などのルールがある場合があります。）  


### リクエストヘッダーで送信
リクエストヘッダーには独自のヘッダーを定義することが出来ます。  
これにパラメータを記載します。  

全リクエスト共通で送りたいパラメータがある場合などに利用します。  
(ボディの記述形式に関わらずパラメータを設定することが出来るため)  
例えば認証情報や、ログの為のパラメータなどです。  

例
```js
const response = await fetch(url, {
  method: 'POST', 
  headers: {'MyHeader': 'MyValue'},  //ヘッダーにパラメータを設定
  body: JSON.stringify(parameter) 
})
const result = await response.json(); 
```
ヘッダーは共通の関数で一律に設定することが多いです。　  

### どの方法を使うか

- ブラウザからのリクエストの場合  
  クエリストリングかフォームデータのいずれかになります。  
  以下のように使い分けることが多いです。

  - パラメータに重要な情報を含まない参照系の処理  
    →クエリストリング
  - その他の処理  
    →フォームデータ
  
- Javascriptからリクエストを送信する場合の場合  
  配列やネストしたデータも受け渡しやすい為、Json文字列としてリクエストボディに記述することが多いです。    

最終的にはそれぞれの方法の特性とWebページの特性を考慮し、設計者・開発者が決めることになります。    


## サーバー側の実装
クライアントからパラメータを渡す場合、サーバー側は動的にWebページを作成する場合が多いです。  
(検索条件に対して検索結果ページを動的に作成 など)  
この場合、サーバー側では動的ページを作成する為の（JavaやC#などで作った）プログラムを実行することになります。  
(サーバー側プログラムについては[別記事](3_1.Webサーバーの構成.md)で解説します。)

ここでは、クライアントから送られたパラメータを、サーバー側のプログラムから取得する実装について紹介します。  
（言語やフレームワークによって取り方は違いますので、雰囲気が伝わればと思います。）  

サーバー側のプログラムを作る際、Web関連の処理を行うためのライブラリを使うことが一般的です。  
(Java ServletやASP.NETなど)  
それらのライブラリには、リクエストメッセージを表すクラスが存在し、そこにクエリストリングやヘッダー情報などが格納される作りになっていることが多いです。  
ライブラリはリクエストメッセージからそのクラスのインスタンスを生成するところまでを行ってくれます。  

ここではC#のASP.NET MVCの場合の実装例を示します。  
（上の各リクエスト例と同じ、addressというパラメータが送られて来た場合の例）  
```c#
 //リクエストメッセージを表すクラスのインスタンスを取得。
 //HttpContextというプロパティ経由で取得できる。
HttpRequest request = HttpContext.Request; 

//ヘッダー情報の取得
string myHeaderValue = request.Headers["MyHeader"];

//クエリストリングのパラメータを取得
string queryStringValue = request.Query["address"];

//フォームデータのパラメータを取得
string formValue = request.Form["address"];

//リクエストボディの取得。
string bodyString = new StreamReader(request.Body).ReadToEnd();
//（取得した文字列がJsonと想定）Json文字列をC#側で用意したクラスのインスタンスに変換する。
MyParameter parameter = JsonSerializer.Deserialize<MyParameter>(bodyString); 
```

ただ最近の開発においては、Web用のライブラリをさらに使いやすくするためのフレームワークを使用することが多いです。  
(JavaのSpring MVCやC#のASP.NET MVCなど)  

それらのフレームワークは、リクエストのパラメータをあらかじめ用意したクラスのインスタンスに変換する処理を行ってくれます。  

ASP.NET MVCの例

```C#
//クライアントからのパラメータ名と同名のプロパティをもつクラスを定義しておく。
public class MyParameter
{
    public string name { get; set; }
    public string address { get; set; }
}

～
public class HomeController : Controller
{
    //リクエストに対応するメソッドが呼び出される際、
    //引数に指定したクラスのインスタンスがパラメータから自動生成される。
    public async Task<IActionResult> Index(MyParameter parameter)
    {
       Console.WriteLine(parameter.address); //hokkaido
    }
}
```

サーバー側プログラムではこのようにしてリクエストメッセージからパラメータを取りだします。  

## 実装時の注意  
あるリクエストについてどの方法でパラメータを渡すか決めた際は、クライアント（ブラウザ）側のHTMLやJavascriptのパラメータ送信方法と、サーバー側のパラメータ取得方法を合わせて実装する必要があります。  
例えばクエリストリングで送ると決めれば、クライアント側はクエリストリングにパラメータを記載するよう実装し、サーバー側はクエリストリングからパラメータを取得するように実装することになります。  
クライアント側もサーバー側も同じ開発者が実装する場合（このケースが多いです）は特に問題無いのですが、もし別々の開発者が実装する場合は、事前に受け渡し方法についてよく確認しておくことが大事です。    


## まとめ
それぞれの渡し方をまとめると以下になります。  

|    |  HTTPメソッド  |  送信元  | パラメータの記載場所   |  リクエストのcontent-type  |
| ---- | ---- | ---- | ---- | ---- |
|  クエリストリングで送信   |  GET  | ブラウザ or Javascript  | URL  | 任意  |
|  フォームデータで送信  |  GET or POST <br>(formタグのmethod属性で指定する)  | ブラウザ or Javascript   | リクエストボディ  | application/x-www-form-urlencoded  |
|  Json形式で送信  |  任意  | Javascript   | リクエストボディ  | application/json  |
|  リクエストヘッダーで送信  |  任意  | Javascript  | リクエストヘッダー  | 任意  |

