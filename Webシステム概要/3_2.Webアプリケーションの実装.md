# Webアプリケーションの実装

## なにこれ？ 
Webアプリケーションとはアプリケーションサーバー上で動作するプログラムのことです。  
ここでは、Webアプリケーションをどのように実装するかについて説明します。  

## アプリケーションサーバーに配置できるプログラム
APサーバーにはどんな実装のプログラムでも配置できるわけではありません。  
例えば、Mainメソッドでコンソール画面にHelloWorldと出力するだけのプログラムは配置できません。  

**APサーバーに配置できるのは、APサーバーが想定する仕様にそって実装されたプログラムだけです。**  

この仕様は言語やAPサーバーごとに決められています。  

たとえばJavaには「**Java Servlet**」というWebアプリの為の仕様があり、Java系のAPサーバー(TomcatやJBossなど)はこの仕様に沿ったプログラムしか配置できません。    
（その為これらのAPサーバーは「サーブレットコンテナ」とも呼ばれます。） 

それらのAPサーバーに配置するWebアプリを開発する場合、開発者はJavaServletの仕様に沿ってプログラムを実装していくことになります。  

図?

以降ではJavaでWebアプリ開発する場合を例に、具体的な実装方法について説明していきます。  
(他の言語も大体似たような仕組みのはずです)  

## JavaでのWebアプリ開発
Javaには「**Java Servlet**」というWebアプリの為の仕様があると説明しました。  
(以降では省略して**サーブレット**と呼びます)

以降ではこのサーブレットを用いた開発方法について説明していきます。  

### Java Servletとは
JavaSerletとは、Webアプリが実装するインターフェース(interface)を定義したものです。  
(public interface ～のように記述する、プログラム的な意味のインターフェースの事です。)

サーブレットの[定義書](https://github.megascus.dev/servlet-spec/docs/apidocs/)を見ると、様々なインターフェースが定義されています。  
例えばリクエストメッセージを表す「HttpServletRequest」や、レスポンスメッセージを表す「HttpServletResponse」などのインターフェースが定義されています。

HttpServletRequestの[定義](https://github.megascus.dev/servlet-spec/docs/apidocs/)をみると、以下のように記載されています。  
> 「サーブレットコンテナはHttpServletRequestを作成してサーブレットのservice(doGet、doPost、など)メソッドの引数として渡します。」

また、HttpServletRequestで定義されている各メソッドについても説明されています。  
例えば以下のようなメソッドが定義されています。  

> String getHeader(String name)
> 
> リクエストヘッダーの指定された値をStringとして返します。 リクエストが指定された名前のヘッダーを含まない場合はnullを返します。 もしヘッダーに同じ名前で複数の値が含まれていた場合、このメソッドはリクエストの最初のヘッダーを返します。 ヘッダー名は大文字小文字を区別しません。 このメソッドは任意のリクエストヘッダーに対して使用できます。
> 
> パラメータ:
> name - ヘッダー名を指定する名前のString
> 戻り値:
> リクエストのヘッダーの値を含むString、リクエストのヘッダーがその名前を持たない場合はnull

このように、JavaServletでは以下の情報が定義されています。  
- ある情報をどのインターフェースで表現するか  
例えばリクエストメッセージの情報は「HttpServletRequest」インターフェースで表現される。  

- そのインターフェース（を実装したクラス）はどのように作成されるか  
「サーブレットコンテナはHttpServletRequestを作成してサーブレットのservice(doGet、doPost、など)メソッドの引数として渡します。」など

- そのインターフェースはどのようなメソッドを持ち、そのメソッドはどのような処理を行うべきか

- そのメソッドはどのようなシグニチャか

※ シグニチャとは、メソッド名、引数の数とそれぞれの型、返り値の型の定義の事です。  

重要なのは、Servletはあくまでインターフェースの集まりであり、**実装は提供していない**ということです。  
インターフェースを継承し、実際の処理を記述したクラスは含まれません。  


### JavaServletの実装
開発者がサーブレットインターフェースの実装を開発することは難しいです。  
例えばHttpServletRequestインターフェースを実装したクラスは、そもそもAPサーバーがどのようにリクエストメッセージを保持しているか分からないと作成できません。  

例えばgetHeaderメソッドは、そもそもAPサーバーがどのようにリクエストメッセージを保持しているか分からないと実装できません。  

ではサーブレットの実装はどのように提供されるのでしょうか？  
**サーブレットの実装は、各APサーバーにより提供されます。**  

例えばtomcatでは「servlet-api.jar」という、サーブレットの実装クラスをまとめたライブラリをjarファイルとして提供しています。  
他のAPサーバーでは、JBossは「jboss-servlet-api*.jar」、WebSphereで「j2ee.jar」という名前でjarファイルを提供しています。  

これらのjarファイルは名前は違いますが、中身はJavaServletのインターフェースを実装したクラス群なので、jar内に含まれるクラス名やメソッドのシグニチャは同じです。  

> note  
その為、どのjarを参照したとしても、開発者が実装するプログラムは同じになります。  
もし配置先のAPサーバーが変更されたとなっても、参照するサーブレットjarをそのAPサーバーのものに変更すればよいだけです。  

HttpServletRequestを実装したクラスや、リクエストメッセージからそれを作成する処理などは、このjarファイル内に実装されています。  

開発者はこのjarファイル内のクラス・メソッドを利用してプログラムを開発していきます。  

### 開発者が実装する部分
リクエストやレスポンスに関わる部分を処理する、JavaServletの実装は各APサーバーが提供されているライブラリの中で行われます。  
開発者は、それを利用した具体的な処理を実装していきます。  

例えば、マイページのHTMLを作成する、という処理の場合、DBからユーザーデータを取得したり、それをもとにHTMLを作成する部分を実装します。  

### 実装方法
サーブレットの場合、ライブラリが提供する「」を継承したクラスを作成し、その中に処理を記述していきます。  

例えば以下のようなコードを記述します。  

```java
@WebServlet({"/path/*", "*.ext"})
public class MyServlet extends HttpServlet {

  protected void doGet(HttpServletRequest request, HttpServletResponse response)
        throws ServletException,IOException {

    response.getWriter()
       .append("<html><body>");

  }
}
```
URLのパスが```@WebServlet```で指定したパラメータと一致し、GETメソッドだった場合にこの処理が呼び出されます。  

パスが一致するかの判断や、クラスのインスタンス化、メソッドへ渡す引数（HttpServletRequest、HttpServletResponse）の作成、メソッドの呼び出しなどの処理ははライブラリ側が行ってくれています。  

開発者が実装するのはその後の部分になります。  

HttpServletRequestやHttpServletResponseを作成してこのメソッドを呼び出す処理はライブラリ側が行ってくれています。  


図  




### Webアプリの作成方法
このようなWebアプリを作成することは難しくはありません。
主要なIDE（Eclipseなどの統合開発環境）では、Webライブラリを使用したプロジェクトを作るメニューが存在しており、これを利用すると簡単に作成できます。  


図  

結果の図  


最初から必要な処理が定義、設定された状態のプロジェクトが作成されますので、そのまま利用してもいいですし、必要な箇所は変更しながら利用できます。  

```java

```

### ここまでのまとめ

- APサーバーに配置できるのは、APサーバーが想定する仕様にそって実装されたプログラムだけ
- Javaではその仕様は「Java Servlet」と呼ばれる
- Java Servletの実装は各APサーバーがjarとして提供している。
- そのjar内のクラス・メソッドを適切に利用したプログラムがWebアプリ
- Webアプリのひな形はEclipseなどのIDEから簡単に作成できる。


### .NETのWebアプリ
他の言語として、マイクロソフトの.NET(C#、VB)でWebアプリを作成する場合についても簡単に説明します。  

マイクロソフトはWebアプリを構築するためのツールとライブラリ群を提供しており、これは「ASP.NET」と呼ばれます。    
（ライブラリ群はdll形式で提供されており、javaで各APサーバーが提供しているjarにあたるものです。）  

.NETのバージョン5未満（4.xまで）では、ASP.NETのライブラリ群はマイクロソフトが提供しているもの以外存在せず、それを利用して作成したWebアプリは同じくマイクロソフト製のAPサーバーである「IIS」にしか配置できませんでした。  
（Javaのように様々なAPサーバーが存在し、各APサーバーがサーブレットの実装を提供している状態とは異なります。）  

.NET 5以降はライブラリ自体がAPサーバーの機能を内包するようになっており、APサーバーに配置するのではなくそれ自体で独立して動作するようになりました。  

図  
参考[]()

どちらの場合も、結局はWebアプリ用のライブラリを利用して開発するという点で変わりはありません。  


ASP.NETを利用したWebアプリの作成は、マイクロソフトのIDEである「VisualStuido」から簡単に行えます。  

マイクロソフトのIDEである「VisualStuido」からASP.NET用のプロジェクトを簡単に作成することが出来ます。  



## Webフレームワーク
サーブレットなどの実装ライブラリを使うとWebアプリケーションを作成することが出来ます。  
ただその場合、少し記述な冗長になってしまいます。  

たとえばJavaサーブレットでは、パス毎、GETやPOSTのメソッド毎にしか処理を記述できず、複数のパスに対する処理を1つのクラスにまとめることが出来ませんでした。  
またリクエストパラメータをJavaのオブジェクトに変換する処理も自分で実装する必要がありました。    



そのような手間を省くため、実際の開発時はそれらのWebライブラリをより使いやすくするためのフレームワークを利用する事が多いです。  

たとえばJavaの場合はSpringMVCなどが有名です。  

例えばスプリングの場合、同じ処理を以下のように記述できます。  

フレームワークを利用しなかった場合  
```java


```

フレームワークを利用した場合  
```java


```

このようなフレームワークを利用する場合、サーブレットなどの仕組みはフレームワークの裏側に隠ぺいされ、直接触ることは少なくなります。  

図  



これらのフレームワークはサードパーティー製の場合もありますし、言語の自体の開発元が作成している場合もあります。  

例えば、.NETのWebフレームワークであるASP.NETはMicrosoftが開発しています。  


例  
```

```

各言語ごとによく使われるWebフレームワークがあります。  
Java  Spring MVC 
.NET ASP.NET
Ruby Ruby on Rails


## HTMLを作成しやすくする機能
Appサーバーは処理の結果として、動的に作成したHtmlなどの文字列を返します。  
（Javascriptやcssを動的に作る場合もありますし、Jsonの文字列を返す場合もあります。）  

ただ、そのような文字列は文字数も多くなる為、サーバー側の言語で作るのは大変です。  
例えば、JavaのServletでは以下のようなコードになってしまいます。  
```

```
こうすると開始タグと終了タグの関連も分かりにくくなりますし、ダブルクオーテーションなどをエスケープする必要もあります。  

これを解消する為、大半のWebライブラリは、このような文字列を簡単に作る為の機能を持っています。  
JavaだとJsp、ASP.NETだとRazorなどです。  
(同じ言語でも使っているライブラリやフレームワークにより異なります。)  

以下のように普通のテキストファイルのように自由に記述出来、サーバーアプリの変数も埋め込めます。  
JSPの例
```

```

実際にビルドするした際は、内部的に最初に見たような文字列を作成するコードに置き換えられます。  
(埋め込んだサーバー側の変数もこの時評価されます。)  

その結果として出力された文字列が、クライアントにレスポンスされることになります。  




#### Appサーバーへのプログラムの配置方法 
デプロイとは「配置する」、「展開する」という意味で、作成したプログラムをAppサーバーに配置する際などに使われる言葉です。  

作成したWebアプリケーションをAppサーバーにデプロイする方法は、PPサーバーにより異なります。  
基本的にビルドしたプログラムを特定のフォルダに配置し、パスやポートと対応付ける設定を行います。  
それを簡単に行うための機能が用意されているAppサーバーも多いです。  

例  
IISの例  

Tomcatの例  



## 参考




### 旧

主要な開発言語にはアプリケーションサーバー上で動作するプログラム（以下Webアプリと呼びます）を作成するためのライブラリやフレームワークが用意されています。  

それらのライブラリのフレームワークのルールに乗っ取って処理を実装していきます。  
（例えばWebサーバーアプリが起動したときにはこのメソッドが呼ばれる、URLと対応するメソッドは項定義する、リクエストボディの内容はこの変数に入っている　など）


例

同じ言語でも異なるフレームワークを使うと実装方法が異なります。  

javaの場合  

- Servlet  
Webアプリケーション実装時の仕様。  
例えば以下のような仕様が定義されている。  
  - Webサーバーアプリが起動したときにはこのメソッドが呼ばれる
  - URLと対応するメソッドは項定義する
  - リクエストボディの内容はこの変数に入っている  
  など

- j2ee.jar  
サーブレットの仕様通りに実装されたライブラリ。  
各Appサーバーが用意している。  
またeclipseなどのIDEでも用意されている事が多い。  
(開発時はIDEのjarを利用し、本番時は配置先のAppサーバーのjarを利用する。)

図  


標準のサーブレットだと記述が上長になる為、外部のWebフレームワークライブラリを利用する事も多いです。  
著名なWebフレームワークであるSpringBootを利用すると、Appサーバー(Tomcat)自身を内包した形でプログラムをビルドすることも可能です。  
この場合、Appサーバーアプリがインストールされていない環境でもそのまま実行できます。  
（実行すると作成したプログラムが配置されたTomcatが立ち上がる。）  
こちらの形式の方が取り回ししやすい為、最近のアプリはこの形式が多いです。  

図  

.NETも今はこの形式になっています。  


servlet-apiとAPサーバーの関係  
https://stackoverflow.com/questions/25256768/understanding-who-provides-servlet-api-jar-is-it-web-container-or-part-of-java

各AppサーバーのJ2EEのjar  
https://www.microfocus.co.jp/manuals/ED60/VS2017/GUID-7B2BE673-515D-4204-9B5E-F23B4603D4AE.html

サーブレットの実装  
https://qiita.com/toshi_solution/items/75560ac5353a16703ddc

https://www.ulsystems.co.jp/archives/035.html

spring mvc  
https://spring.pleiades.io/spring-framework/docs/current/reference/html/web.html  

springのメリット  
https://stackoverflow.com/questions/10775522/raw-servlet-vs-spring-mvc

https://www.quora.com/Which-is-better-Java-servlets-or-Spring-to-develop-a-good-website
Springでは、国際化とローカリゼーション、sitemeshのより良い使用、依存性注入、aop、アドバイスなど、jspサーブレットでは得られない多くの機能が提供されます。  

https://spring.pleiades.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/DispatcherServlet.html

spring-boot  
https://www.slideshare.net/OgawaTakeshi/spring-boot-71285225

サーバサイド Web サイトプログラミング  
https://developer.mozilla.org/ja/docs/Learn/Server-side


