# Webサーバーの構成  

## なにこれ？  
Webページの表示の流れを説明した際の図では、Webサーバーを１つの箱で表していました。  
図  

実際にはWebサーバーだけで動作することは少なく、AppサーバーやDBサーバーというサーバーと協調して動作することが多いです。  

そのあたりの仕組みについて説明していきます。  


## Webサーバーアプリの役割  
まずはWebサーバーアプリの主な機能について説明します。  
（AppサーバーやDBサーバーについては後半説明していきます。）  

Webサーバーアプリの主な機能は、クライアントからのHTTPリクエストを受け取り、応答（htmlなど）を返却することです。   
例えば特定のURLパスの場合に、特定のディレクトリに配置しているHtmlファイルをHTTPレスポンスで返却出来ます。  
（Htmlファイルの中身の文字列をHTTPレスポンスのレスポンスボディにコピーして返却します。）    

図  

ただそれだけではなく、HTTPの処理に関する様々な機能を持っています。  
例えば以下のような機能を持ちます。  

- 特定IPアドレスの場合フィルタ（リクエストを許可/拒否）する  
- 特定URLの場合リダイレクトさせる  
- 特定URLの拒否  
- SSL化による通信の暗号化  
- リクエストに応じて特定のサーバへ処理を振り分ける  
- リクエスト・レスポンスヘッダーの書き換え  
- gzip圧縮・解凍
- HTTP認証（Basic認証など）

このように、HTTP通信に関する機能を豊富に持っているのがWebサーバーアプリです。  
例  
[nginxというWebサーバーの機能一覧](https://nginx.org/en/)


### 代表的なWebサーバーアプリ

- nginx  
	2004に初版がリリースされた、比較的新しいWebサーバーです。  
  イベント駆動アプローチを採用しており、高負荷下においてパフォーマンスが安定しています。  

- Apache Http Server  
  1995年に初版がリリースされた、古くから使われているWebサーバーです。  
  歴史が長いだけあり導入事例も多く、スキルを持った人も多いです。  
  
  nginxと比べると設定の記述方法がやや複雑で、リクエスト数が多くなった場合のパフォーマンスも少し劣ります。  
  リクエストの処理にデフォルトでスレッドやプロセス指向をもちいており、高負荷下時のパフォーマンスが少し劣ります。  

- IIS  
  Windoswでのみ動作するWebサーバーです。  
  WindowsServerには最初からバンドルされています。  
  また、サーバー側のプログラムが.NETの場合、Appサーバーとしても動作します。  
  （Appサーバーの説明は後ほど行います。）  
  


## Webサーバーアプリで出来ないこと（動的コンテンツの作成）

Webサーバーアプリだけでもクライアントからのリクエストに応答できるのですが、Webサーバーアプリだけだと実現しにくい機能があります。  
それが**動的コンテンツ**の作成です。   
対になる**静的コンテンツと**一緒に以下説明します。  

- 静的コンテンツ  
閲覧する条件によって内容が変わらないコンテンツ。  
ヘルプページや利用規約ページのhtmlや、画像ファイル、外部ファイルとして定義してcss・javascriptなど。    

- 動的コンテンツ  
閲覧する条件によって内容が変わるコンテンツ。  
例えばマイページのようなユーザーによって内容が変わるWebページや、検索条件によって内容が変わる商品一覧ページのhtmlなどです。    
最近のWebシステムの場合、このような動的コンテンツが必要なことがほとんどです。  



動的コンテンツを作成する為には、DBなどから動的に変わる箇所の情報（ユーザー名など）を取得し、それをもとに返却するコンテンツ（Htmlなど）を作成する、といった処理を行うプログラムが必要になります。  
（このようなプログラムはJavaやC#などで実装します。） 

図  

ただ、Webサーバーアプリにはそのようなプログラムを動かす機能がありません*。  
そのため、プログラムを動作させるためのアプリが必要になります。  
そのようなアプリを**アプリケーションサーバー**といいます。 
   

*Webサーバーと言語の組み合わせによってはWebサーバーでプログラムを動作させることも出来ます。  
ただその場合でも役割を分けることが多いです。  


## アプリケーションサーバー
javaやC#などで作成したプログラムを動作させるためのサーバーアプリです。   

Webサーバーと同じくHTTPリクエストを受け取ることが出来、リクエストの内容に応じて特定の処理を行います。  
(プログラム内の特定のメソッドを実行します。)  
処理の実行結果はHTTPレスポンスで返却します。  

以下処理の流れを説明します。  

図

1. Httpリクエストを受け取る

1. リクエスト内容に応じたプログラムを実行し、DBとのやり取りやブラウザに返却するコンテンツ(Html)の作成を行う。  


1. 結果をHttpレスポンスで返却


主に動的コンテンツを作成する為に利用しますが、Webサーバーと同じように静的コンテンツを返すことも可能です。 
（以下アプリケーションサーバーをAppサーバーと呼びます。）  



### アプリケーションサーバーの実行環境
プログラムを実行させるためには、Appサーバーアプリだけではなく各言語の実行環境(SDK)も必要になります。  
例えばJavaのプログラムを実行するTomcatというAppサーバーアプリを利用したい場合、JDKのインストールや環境変数（JAVA_HOME）の設定などの作業が必要になります。  
（SDKがAppサーバーにバンドルされており、それらの処理が不要な場合もあります。）  

またAppサーバーアプリが稼働しているサーバーをAppサーバーと言います。  

### Appサーバーで動作するプログラムのコード例
Appサーバーで動作するプログラム例を記載します。  
言語やライブラリによって異なるのですが、ここでは C#のASP.NET（Webシステム開発用のライブラリ群）を利用した場合の例を記載します。  
```


```
※イメージしやすいように冗長な書き方をしています。  

このようなコードをAppサーバーに配置します。  
配置方法については後ほど説明します。  


## WebサーバーとAppサーバーの違い   
上述のようにAppサーバーアプリもHTTPリクエストを受け付けてHTTPレスポンスを返すサーバーアプリです。  
また、静的コンテンツも返すことが可能です。  
このようにAppサーバーはWebサーバーと同じような機能を持っています。  

実際、Webサイトの運営は、(動的コンテンツが無ければ)Webサーバーだけでも可能ですし、Appサーバーだけでも可能です。  

こうみるとAppサーバーがあればWebサーバーは不要に見えますし、実際AppサーバーだけでWebサイトを運営することは可能です。  

それではこの２つの違いは何でしょうか。   
**それは、役割の専門性の違いです。**  

AppサーバーではHttpリクエストを受け付けることは出来ますが、WebサーバーのようなHTTP関連の様々な処理（特定のサーバへ処理を振り分けなど）を行うことは苦手です。  
（出来たとしてもWebサーバーより実装が大変なことが多いです。）  

WebサーバーはHttp関連の処理は得意ですが、前述したとおりJavaなどのプログラムを動作させることは出来ません。（ただし一部の言語は動作させれます。）  

このように出来ることは似ていても、得意な処理が異なっています。  

- Webサーバー  
Http周りの処理がメイン。  

- Appサーバー  
プログラムを稼働させるのがメイン。  


|   |  Webサーバー  |  Appサーバー  |
| ---- | ---- | ---- |
|  HTTP通信  |  得意  |  必要最低限  |

## WebサーバーとAppサーバーの使い分け  
ではWebサーバーとAppサーバーをどのように使い分けるのでしょうか。
結論から言うと、両方を同時に使うことが多いです。   
それぞれが得意な部分の処理を担当するイメージです。  

- Webサーバー  
クライアントとの窓口となる。  
クライアントからのリクエストを受付けてAppサーバーを呼び出し、Appサーバーの処理結果をクライアントに返却する。  
Appサーバーの呼び出しはHTTPリクエストにより行う。(処理結果はHTTPレスポンスで受け取る)  
必要であればAppサーバーからのレスポンスヘッダーなどを変更し、クライアントに返却する。  

- Appサーバー  
WebサーバーからのHTTPリクエストを受け、特定の処理（Html文字列の作成など）を実行する。  
処理結果（作成したHtml文字列など）をHTTPレスポンスでWebサーバーに返却する。  


具体的な処理の流れは以下になります。  

1. （Webサーバー）クライアントからのリクエストを受け取る  

1. （Webサーバー）必要に応じた処理を実行（ヘッダーの書き換えなど）  

1. （Webサーバー）AppサーバーにHttpリクエストを転送  
Webサーバーが受け取り必要な変更を加えたHttpリクエストを、WebサーバーがクライアントになりAppサーバーに発行するイメージです。  

1. （Appサーバー）Webサーバーから転送されたリクエストを受け取り、リクエストに応じてプログラムを実行  

1. （Appサーバー）WebサーバーにHttpレスポンスで結果を返却

1. （Webサーバー）Appサーバーから受け取ったHttpレスポンスに対し、必要に応じた処理（ヘッダーの書き換えなど）を実行  

1. （Webサーバー）クライアントにHttpレスポンスを返却  

図  


このように両方のアプリを同時に使い、それぞれの得意な部分の処理を行うようにすることで以下のメリットがあります。  
- 負荷分散  
静的ファイルはWebサーバー、動的ファイルはAppサーバーと役割を分けることが可能になり、負荷を分散出来ます。   

- 保守性の向上  
なんらかの理由でAppサーバーを停止する場合に、Webサーバーの方でメンテンナンス中ページを返す、といったことも可能になります。 


案件で開発するようなシステムの場合は、２つを同時に使うケースが大半です。  
ただ社内の数人しか使わないサイトや、開発中のページを確認したいだけの用途の場合などは、Appサーバーだけを利用する事もあります。  


## WebサーバーとAppサーバーの構成  
WebサーバーとAppサーバーは同時に利用することが多いと書きましたが、サーバー自体の構成としてはどうなるでしょうか。  
結論から言うと、WebサーバーとAppサーバーを別々のサーバーとする場合と、1台のサーバーに同居させる場合があります。  
以下の2つのパターンがあります。  

### 別々のサーバーとする場合  
WebサーバーとAppサーバーを別のサーバーホストに配置します。  

図


Webサーバーアプリにはリクエストを転送する為の設定を記述できますので、そこにAppサーバーのアドレスとポートを記載します。 

例  
'''

'''

この構成には以下のメリット・デメリットがあります。  
- メリット  


- デメリット  

アクセス数が多い場合などは、別々のサーバーとすることがあります。  
負荷分散や拡張性が高くなります。 


### 1台のサーバーに同居させる場合  
WebサーバーとAppサーバーを1台のサーバーホストに配置します。  


図  


この場合、Webサーバーは80(HTTP)、443(HTTPS)ポートをリッスンし、Appサーバーは空いている適当なポートをリッスンします。(8080や8443が使われることが多いです)  
Webサーバーはlocalhostに対してリクエストを転送します。  

'''

'''


この構成には以下のメリット・デメリットがあります。  
- メリット  


- デメリット  

アクセス数がそこまで多くない場合など、1台のサーバーに同居させる場合があります。  


### 代表的なAppサーバーアプリ  
言語によって異なります。  

|  言語  |  Appサーバー  |
| ---- | ---- |
|  Java  |  Tomcat、JBoss、Glass Fish  |
|  C#  |  IIS（Webサーバー兼Appサーバーとなる）  |
|  Ruby  |  Unicorn、Rainbows  |
|  PHP  | apache HTTP Serverのプラグイン（Webサーバー兼Appサーバーとなる）  |



## アプリケーションサーバー上で動作するプログラムの実装  
主要な開発言語にはアプリケーションサーバー上で動作するプログラム（以下Webアプリと呼びます）を作成するためのライブラリやフレームワークが用意されています。  

それらのライブラリのフレームワークのルールに乗っ取って処理を実装していきます。  
（例えばWebサーバーアプリが起動したときにはこのメソッドが呼ばれる、URLと対応するメソッドは項定義する、リクエストボディの内容はこの変数に入っている　など）


例

同じ言語でも異なるフレームワークを使うと実装方法が異なります。  

javaの場合  

- Servlet  
Webアプリケーション実装時の仕様。  
例えば以下のような仕様が定義されている。  
  - Webサーバーアプリが起動したときにはこのメソッドが呼ばれる
  - URLと対応するメソッドは項定義する
  - リクエストボディの内容はこの変数に入っている  
  など

- j2ee.jar  
サーブレットの仕様通りに実装されたライブラリ。  
各Appサーバーが用意している。  
またeclipseなどのIDEでも用意されている事が多い。  
(開発時はIDEのjarを利用し、本番時は配置先のAppサーバーのjarを利用する。)

図  


標準のサーブレットだと記述が上長になる為、外部のWebフレームワークライブラリを利用する事も多いです。  
著名なWebフレームワークであるSpringBootを利用すると、Appサーバー(Tomcat)自身を内包した形でプログラムをビルドすることも可能です。  
この場合、Appサーバーアプリがインストールされていない環境でもそのまま実行できます。  
（実行すると作成したプログラムが配置されたTomcatが立ち上がる。）  
こちらの形式の方が取り回ししやすい為、最近のアプリはこの形式が多いです。  

図  

.NETも今はこの形式になっています。  


## DBサーバー
APPサーバーのプログラム（Webアプリ）はDBから取得したデータをもとにクライアントへの返却結果を作成する事が多いです。  

ここではDBサーバーについても簡単に説明します。  

DBサーバーとは簡単に言うと、DBアプリケーション（以下DBと呼びます）が稼働しているサーバーです。  
DBについて代表的なものは以下になります。  

- mysql
- SQLServer
- Oracle
- Postgres
- DB2

各DB毎にデフォルトでリッスンするポートが決まっています。    

|  DB  |  ポート  |
| ---- | ---- |
|  mysql  |  1433  |


このポートに対してWebアプリから認証要求や実行したいSQLを送信します。  

図



## AppサーバーからDBサーバーへのアクセス  
Webアプリ側はDBに対して認証処理をしたり、SQL文を送って結果を受け取る処理を実装する必要があります。   
ただしこれらを1から実装すると大変なので、それらの処理をまとめたライブラリを利用する事が大半です。  
DBの開発元が各言語向けのライブラリを作成しており、無料で取得することが出来ます。（主要な言語向けのものは大抵はあります。）  

このライブラリがコネクション処理やSQL発行の為にDBとやり取りする部分の処理を実装してくれているので、WebアプリはそれにSQLや接続文字列を渡すだけで良くなります。  

図  

大抵のDBは以下のような処理を行います。

- DBへの接続  
DBに対して認証処理を行い、WebアプリからDBに対してSQL実行などを出来るようにします。  

DBサーバーのアドレス、ユーザー名、パスワードなどをまとめた文字列を渡すとDBとの間にコネクションを貼ってくれます。  
これを接続文字列といいます。  

- SQLの発行
その後実行したいSQLを渡すとそのSQLを実行してくれて、実行結果を返却してくれます。  
SQLに埋め込むパラメータの渡し方や、結果の取り出し方はライブラリによって異なります。  

コード例  


#### Appサーバーへのプログラムのデプロイ  
デプロイとは「配置する」、「展開する」という意味で、作成したプログラムをAppサーバーに配置する際などに使われる言葉です。  

デプロイ方法は各APPサーバーにより異なります。  
基本的にビルドしたプログラムを特定のフォルダに配置し、パスやポートと対応付ける設定を行います。  
それを簡単に行うための機能が用意されているAppサーバーも多いです。  

例  
IISの例  

Tomcatの例  


