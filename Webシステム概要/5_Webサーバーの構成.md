# Webサーバーの構成  

## なにこれ？  
Webページの表示の流れを説明した際の図では、Webサーバーを１つの箱で表していました。  
図  

実際にはWebサーバーだけで動作することは少なく、AppサーバーやDBサーバーというサーバーと協調して動作することが多いです。  

そのあたりの仕組みについて説明していきます。  


## Webサーバーアプリの役割  
まずはWebサーバーアプリの主な機能について説明します。  
（AppサーバーやDBサーバーについては後半説明していきます。）  

Webサーバーアプリの主な機能は、クライアントからのHTTPリクエストを受け取り、応答（htmlなど）を返却することです。   
例えば特定のURLパスの場合に、特定のディレクトリに配置しているHtmlファイルをHTTPレスポンスで返却出来ます。  
（Htmlファイルの中身の文字列をHTTPレスポンスのレスポンスボディにコピーして返却します。）    

図  

ただそれだけではなく、HTTPの処理に関する様々な機能を持っています。  
例えば以下のような機能を持ちます。  

- 特定IPアドレスの場合フィルタ（リクエストを許可/拒否）する  
- 特定URLの場合リダイレクトさせる  
- 特定URLの拒否  
- SSL化による通信の暗号化  
- リクエストに応じて特定のサーバへ処理を振り分ける  
- リクエスト・レスポンスヘッダーの書き換え  
- gzip圧縮・解凍
- HTTP認証（Basic認証など）

このように、HTTP通信に関する機能を豊富に持っているのがWebサーバーアプリです。  
例  
[nginxというWebサーバーの機能一覧](https://nginx.org/en/)


### 代表的なWebサーバーアプリ

- nginx  
	2004に初版がリリースされた、比較的新しいWebサーバーです。  
  イベント駆動アプローチを採用しており、高負荷下においてパフォーマンスが安定しています。  

- Apache Http Server  
  1995年に初版がリリースされた、古くから使われているWebサーバーです。  
  歴史が長いだけあり導入事例も多く、スキルを持った人も多いです。  
  
  nginxと比べると設定の記述方法がやや複雑で、リクエスト数が多くなった場合のパフォーマンスも少し劣ります。  
  リクエストの処理にデフォルトでスレッドやプロセス指向をもちいており、高負荷下時のパフォーマンスが少し劣ります。  

- IIS  
  Windoswでのみ動作するWebサーバーです。  
  WindowsServerには最初からバンドルされています。  
  また、サーバー側のプログラムが.NETの場合、Appサーバーとしても動作します。  
  （Appサーバーの説明は後ほど行います。）  
  


## Webサーバーアプリで出来ないこと（動的コンテンツの作成）

Webサーバーアプリだけでもクライアントからのリクエストに応答できるのですが、Webサーバーアプリだけだと実現しにくい機能があります。  
それが**動的コンテンツ**の作成です。   
対になる**静的コンテンツと**一緒に以下説明します。  

- 静的コンテンツ  
閲覧する条件によって内容が変わらないコンテンツ。  
ヘルプページや利用規約ページのhtmlや、画像ファイル、外部ファイルとして定義してcss・javascriptなど。    

- 動的コンテンツ  
閲覧する条件によって内容が変わるコンテンツ。  
例えばマイページのようなユーザーによって内容が変わるWebページや、検索条件によって内容が変わる商品一覧ページのhtmlなどです。    
最近のWebシステムの場合、このような動的コンテンツが必要なことがほとんどです。  

静的コンテンツを返却する場合、返却すべき内容を記載したファイル(.htmlなど)をあらかじめ用意しておき、そのファイルの中身の文字列をHttpレスポンスに記載します。    

動的コンテンツを返却する場合、DBなどから動的に変わる箇所の情報（ユーザー名など）を取得し、それをもとに返却するコンテンツ（Htmlなど）を作成する、といった処理を行うプログラムが必要になります。  
（このようなプログラムはJavaやC#などで実装します。） 

図  

Webサーバーは静的コンテンツを返却する機能を持ちますが、動的コンテンツを作成するプログラムを動かす機能がありません*。  

そのため、プログラムを動作させるためのアプリが別途必要になります。  
そのようなアプリを**アプリケーションサーバー**といいます。 
   

*Webサーバーと言語の組み合わせによってはWebサーバーでプログラムを動作させることも出来ます。  
（Webサーバー兼APPサーバーのようになります。）  



## アプリケーションサーバー
javaやC#などで作成したプログラムを動作させるためのサーバーアプリです。   

Webサーバーと同じくHTTPリクエストを受け取ることが出来、リクエストの内容に応じて特定の処理を行います。  
(プログラム内の特定のメソッドを実行します。)  
処理の実行結果はHTTPレスポンスで返却します。  

以下処理の流れを説明します。  

図

1. Httpリクエストを受け取る

1. リクエスト内容に応じたプログラムを実行し、DBとのやり取りやブラウザに返却するコンテンツ(Html)の作成を行う。  


1. 結果をHttpレスポンスで返却


主に動的コンテンツを作成する為に利用しますが、Webサーバーと同じように静的コンテンツを返すことも可能です。 
（以下アプリケーションサーバーをAppサーバーと呼びます。）  



### アプリケーションサーバーの実行環境
プログラムを実行させるためには、Appサーバーアプリだけではなく各言語の実行環境(SDK)も必要になります。  
例えばJavaのプログラムを実行するTomcatというAppサーバーアプリを利用したい場合、JDKのインストールや環境変数（JAVA_HOME）の設定などの作業が必要になります。  
（SDKがAppサーバーにバンドルされており、それらの処理が不要な場合もあります。）  

またAppサーバーアプリが稼働しているサーバーをAppサーバーと言います。  

### Appサーバーで動作するプログラムのコード例
主要な開発言語にはアプリケーションサーバー上で動作するプログラム（以下Webアプリと呼びます）を作成するためのライブラリやフレームワークが用意されています。  

それらのライブラリのフレームワークのルールに乗っ取ってコードを実装していきます。  
（例えばWebサーバーアプリが起動したときにはこのメソッドが呼ばれる、URLと対応するメソッドは項定義する、リクエストボディの内容はこの変数に入っている　など）

言語やライブラリによって異なるのですが、ここでは C#のASP.NET（Webシステム開発用のライブラリ群）を利用した場合の例を記載します。  
```


```
※イメージしやすいように冗長な書き方をしています。  

このようなコードをAppサーバーに配置します。  
詳細については別記事で解説します。  


## WebサーバーとAppサーバーの違い   
上述のようにAppサーバーアプリもHTTPリクエストを受け付けてHTTPレスポンスを返すサーバーアプリです。  
また、静的コンテンツも返すことが可能です。  
このようにAppサーバーはWebサーバーと同じような機能を持っています。  

実際、Webサイトの運営は、(動的コンテンツが無ければ)Webサーバーだけでも可能ですし、Appサーバーだけでも可能です。  

こうみるとAppサーバーがあればWebサーバーは不要に見えますし、実際AppサーバーだけでWebサイトを運営することは可能です。  

それではこの２つの違いは何でしょうか。   
**それは、役割の専門性の違いです。**  

AppサーバーではHttpリクエストを受け付けることは出来ますが、WebサーバーのようなHTTP関連の様々な処理（特定のサーバへ処理を振り分けなど）を行うことは苦手です。  
（出来たとしてもWebサーバーより実装が大変なことが多いです。）  

WebサーバーはHttp関連の処理は得意ですが、前述したとおりJavaなどのプログラムを動作させることは出来ません。  

このように出来ることは似ていても、得意な処理が異なっています。  

- Webサーバー  
Http周りの処理がメイン。  

- Appサーバー  
プログラムを稼働させるのがメイン。  


|   |  Webサーバー  |  Appサーバー  |
| ---- | ---- | ---- |
|  HTTP通信に関わる処理  |  得意  |  必要最低限  |
|  動的コンテンツの作成  |  不可 <br/>（Webサーバーと言語の組合せ<br/>によっては可能）  |  可能  |
|  静的コンテンツの配布  |  可能  |  可能  |

## WebサーバーとAppサーバーの使い分け  
ではWebサーバーとAppサーバーをどのように使い分けるのでしょうか。  
結論から言うと、両方を同時に使うことが多いです。   
それぞれが得意な処理を担当するイメージです。  

- Webサーバー  
クライアントとの窓口となる。  
クライアントからのリクエストを受付けてAppサーバーを呼び出し、Appサーバーの処理結果をクライアントに返却する。  
Appサーバーの呼び出しはHTTPリクエストにより行う。(処理結果はHTTPレスポンスで受け取る)  
必要であればAppサーバーからのレスポンスヘッダーなどを変更し、クライアントに返却する。  

- Appサーバー  
WebサーバーからのHTTPリクエストを受け、特定の処理（Html文字列の作成など）を実行する。  
処理結果（作成したHtml文字列など）をHTTPレスポンスでWebサーバーに返却する。  


具体的な処理の流れは以下になります。  

1. （Webサーバー）クライアントからのリクエストを受け取る  

1. （Webサーバー）必要に応じた処理を実行（ヘッダーの書き換えなど）  

1. （Webサーバー）AppサーバーにHttpリクエストを転送  
Webサーバーが受け取り必要な変更を加えたHttpリクエストを、WebサーバーがクライアントになりAppサーバーに発行するイメージです。  

1. （Appサーバー）Webサーバーから転送されたリクエストを受け取り、リクエストに応じてプログラムを実行  

1. （Appサーバー）WebサーバーにHttpレスポンスで結果を返却

1. （Webサーバー）Appサーバーから受け取ったHttpレスポンスに対し、必要に応じた処理（ヘッダーの書き換えなど）を実行  

1. （Webサーバー）クライアントにHttpレスポンスを返却  

図  


このように両方のアプリを同時に使い、それぞれの得意な部分の処理を行うようにすることで以下のメリットがあります。  
- 負荷分散  
静的ファイルはWebサーバー、動的ファイルはAppサーバーと役割を分けることが可能になり、負荷を分散出来ます。   

- 保守性の向上  
なんらかの理由でAppサーバーを停止する場合に、Webサーバーの方でメンテンナンス中ページを返す、といったことも可能になります。 


案件で開発するようなシステムの場合は、２つを同時に使うケースが大半です。  
ただ社内の数人しか使わないサイトや、開発中のページを確認したいだけの用途の場合などは、Appサーバーだけを利用する事もあります。  


## WebサーバーとAppサーバーの構成  
WebサーバーとAppサーバーは同時に利用することが多いと書きましたが、サーバーホストの構成としてはどうなるでしょうか。  
結論から言うと、WebサーバーとAppサーバーを別々のサーバーとする場合と、1台のサーバーに同居させる場合があります。  
以下の2つのパターンがあります。  

### 別々のサーバーとする場合  
WebサーバーとAppサーバーを別のサーバーホストに配置します。  

図


Webサーバーアプリにはリクエストを転送する為の設定を記述できますので、そこにAppサーバーのアドレスとポートを記載します。 

例  
'''

'''

この構成には以下のメリット・デメリットがあります。  
- メリット  


- デメリット  

アクセス数が多い場合などは、別々のサーバーとすることがあります。  
負荷分散や拡張性が高くなります。 


### 1台のサーバーに同居させる場合  
WebサーバーとAppサーバーを1台のサーバーホストに配置します。  


図  


この場合、Webサーバーは80(HTTP)、443(HTTPS)ポートをリッスンし、Appサーバーは空いている適当なポートをリッスンします。(8080や8443が使われることが多いです)  
Webサーバーはlocalhostに対してリクエストを転送します。  

'''

'''


この構成には以下のメリット・デメリットがあります。  
- メリット  


- デメリット  

アクセス数がそこまで多くない場合など、1台のサーバーに同居させる場合があります。  


### 代表的なAppサーバーアプリ  
言語によって異なります。  

|  言語  |  Appサーバー  |
| ---- | ---- |
|  Java  |  Tomcat、JBoss、Glass Fish  |
|  C#  |  IIS（Webサーバー兼Appサーバーとなる）  |
|  Ruby  |  Unicorn、Rainbows  |
|  PHP  | apache HTTP Serverのプラグイン（Webサーバー兼Appサーバーとなる）  |



## DB（データベース）サーバー

データベースとは、検索や蓄積が容易にできるよう整理された情報の集まりのことです。  
データベースを作成、管理する為のソフトウエアをデータベース管理システム（DBMS）と呼びます。  
DBサーバーとは、DBMSが稼働しているサーバーのことを指します。  

図  


DBMSについて代表的なものは以下になります。  
（以下DBMSをDBと呼びます。）  

- mysql
- SQLServer
- Oracle
- Postgres
- DB2

DBはSQLという言語で操作します。(INSERT文でデータ登録、SELECT文でデータ検索など)  
（SQLについては別記事で解説します。）  


各DB毎にデフォルトでリッスンするポートが決まっており、外部からの接続を受け付けることが出来ます。     

|  DB  |  デフォルトポート  |
| ---- | ---- |
|  mysql  |  3306  |
|  SQLServer  |  1433  |
|  Oracle  |  1521  |
|  Postgres  |  5432  |


## AppサーバーからDBサーバーへのアクセス  
APPサーバーのプログラム（Webアプリ）は、データベースから取得したデータをもとにクライアントへの返却結果を作成する事が多いです。  

WebアプリはDBサーバーと通信し、実行したいSQLなどを送信し、結果を受け取ります。  

図  

### DBとの通信方法
DBサーバーとの通信時は、HTTPではなく、各DBMSが定めたプロトコルにしたがってデータをやり取りします。  
例えばmysqlと通信するには[mysqlプロトコル](https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_PROTOCOL.html)というプロトコルに従って通信する必要があります。  
プロトコルではどのように認証するかやどのような形式でデータを送るかが定義されています。  

ただこのプロトコルは複雑で、プロトコルに従って通信する処理を1から実装するのは非常に大変です。  
またDB毎にプロトコルが異なるので、DB毎に通信処理を実装しなくてはいけません。  
 
その為、実際の開発時には、それらの処理をまとめたライブラリを利用する事が大半です。  

### DBとの接続処理を行うライブラリ
各DBMSの開発元は、DBとやりとりする処理を実装したライブラリを配布しています。  
（ドライバ、コネクタなどとも呼ばれます。)  

どのDBMSも主要な言語向けのドライバを用意してます。  
例：[mysqlの各言語向けのドライバ一覧](https://www.mysql.com/jp/products/connector/)  

ライブラリを介すことで、WebアプリはDBMSのプロトコルを意識せずにDBとやり取りを行えます。  

### コード例 
C#でmysqlのC#用のドライバを用いたコード例を記載します。  

- 接続開始処理  
まずはDBに対して認証処理を行い、通信可能な状態にする必要があります。  
DBサーバーのアドレス、認証用のユーザー名、パスワードなどをまとめた**接続文字列**と呼ばれる文字列をを渡すとDBとの間にコネクションを貼ってくれます。  

```

```



- SQLの発行  
接続開始後、実行したいSQLを渡すとそのSQLを実行してくれて、実行結果を返却してくれます。  
SQLに埋め込むパラメータの渡し方や、結果の取り出し方はライブラリによって異なります。 

```

```



## まとめ
以上説明した、Webサーバー、Appサーバー、DBサーバーを使用する構成をまとめると以下になります。  


図  


このような構成は「Web3層構成」などと呼ばれます。  
大半のシステムはこの構成を元にしたサーバー構成とすることが多いです。  




