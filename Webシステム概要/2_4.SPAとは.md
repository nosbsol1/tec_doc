# SPA（シングルページアプリケーション）とは  


## SPA（シングルページアプリケーション）とは  
ブラウザでリンクを遷移した場合やWebページをリフレッシュした際、タブの横にロード中のマークが表示され、画面が一瞬真っ白になった後に画面が再描画されます。  
（この記事では以降、このような動作を「ページ全体の再読み込み」と呼ぶことにします。） 

<img src="画像/ブラウザがHTTPリクエストを送るタイミング_ページ全体の再読み込み.gif" style="width:360px;">   

この際、ブラウザは再度WebサーバーからHTMLなどを取得しなおし画面を再描画しています。  

このようにページ全体が再読み込みされると、画面の表示に1秒程掛かります。  
そのため、再読み込みが頻繁に発生するとユーザーのストレスとなってしまいます。  

これに対し、**Ajax**（JavascriptでHTTPリクエストを発行し画面の一部を置き換える処理）を利用すると、ページ全体を再読み込みせずにWebページを変更することが可能になります。  
**SPAとは、大部分の処理にAjaxを利用し、従来の画面全体を遷移する処理を極力する無くしたWebサイトの事です。**    

ブラウザ版のOutlookやGmailはSPAといえます。  
メールをクリックすると、ページの再読み込み無しで右側のパネルにメールの本文が表示されます。  

<img src="画像/SPAとは_gmailの例.gif" style="width:360px;"> 


#### MPA（Multiple Page Application）
SPAの対義語は**MPA（Multiple Page Application）**と呼ばれます。  
(あまり使ってる人を見ないですが)  

Webページ全体を再読み込みしながら遷移するWebサイトのことです。  
例えばyahooニュースのようなサイトです。  
（ニュースのリンクをクリックするとリンク先に遷移しページが再読み込みされます。）  

## SPAの特徴
SPAの特徴としては、画面遷移もAjaxで行う事です。  
1枚のHTMLに対してJavaScriptで動的に画面を作成していきます。  

最初にHTMLと各画面を作成する処理が記載されたJavascriptを取得し、以降の画面遷移はJavascriptのDOM APIで行います。  
必要なデータがあれば都度Ajax通信で取得します。  

従来(MPA)と比較すると以下のような違いがあります。  

- MPA  
<img src="画像/SPAとは_MPAフロー.png" style="width:360px;">  

- SPA  
<img src="画像/SPAとは_SPAフロー.png" style="width:480px;">  


SPAで読み込むJavascriptにはHTML要素を配置するロジックが含まれますが、表示するデータまでは含まれません。  
データは都度Ajax通信でサーバーから取得します。  

例えばマイページを描画するロジックの場合、ログインユーザーの名前や住所などのデータをサーバーから取得し、
それらをHTML要素を作成ロジックに渡して実際の要素を生成するような処理になります。  

### SPA利用時に初回に読み込むファイル
SPAを利用する場合は、HTMLは必要最小限の要素しかありません。  
大半の要素はJavascriptから動的に作成されます。  
例えば以下のようなHTMLになります。  
（Javascriptの読み込むタグと、画面を表示する為のdivがあるだけのHTML）

```html
<!DOCTYPE html> 
<html ja>
  <head>
    <meta charset="UTF-8">
  </head>
  <body>
     <div id="app"></div>

     <script src="/mySpa.js"></script>
  </body>
<html>
```

対してJavascriptには各画面を描画する為の処理が記述されます。  
その為、Javascriptのファイルサイズが大きくなりがちです。  


## SPAのメリット  
SPAにする主なメリットは以下になります。  

### 表示速度が速く、操作性が良い   
SPAを利用するメリットは、なにより表示速度が早くなりユーザーストレスが軽減することです。   
ページ上の必要な部分だけを更新するため軽快に動作させることができ、ネイティブアプリに近い表示・操作感を実現することができます。  

### サーバー側の処理が（比較的）シンプルになる  
サーバー側はJSPなどを使ってHTMLを作成する必要がなくなり、JSONなどでデータを返すAPIを提供することに専念する形になります。  
そのため、サーバーサイドの処理がシンプルになります。  


## SPAのデメリット  
SPAにする主なデメリットは以下になります。  

### 初回読み込みの遅延  
Javascriptに各画面を描画する処理が含まれるため、Javascriptのファイルサイズが大きくなります。  
その為、Javascriptを取得する、最初の画面表示時に従来より時間が掛かってしまいます。   
（たとえばトップページを開く際に、検索ページやマイページを描画するロジックも含んだJavascriptを読み込むことになります。）  

レスポンスの圧縮やキャッシュの利用などの工夫をするなどの工夫をする必要があります。    

### クライアント側の処理が複雑になる
クライアント側で動的に画面を生成する処理を行うため、クライアント側の処理が複雑になります。  
素のJavascriptだけでコーディングするのは大変な為、後述するReactなどのライブラリを使って実装していくことが多いです。  

### 戻る・進む履歴、ページリフレッシュへの対応
DOM APIでページを切り替えてもブラウザの戻る・進む履歴には表示されません。  
Ajax通信でサーバーにHTTPリクエストを送信しても同様に履歴には表示されません。  
そのため、そのままだとブラウザの戻る・進む機能が使えないサイトになってしまいます。  

また画面をリフレッシュされた場合、保持しているJavascriptなどの変数が初期化されてしまいます。  
その場合でも再度サーバーからデータを取得し画面を描画するよう実装する必要があります。  

対応としては、JavascriptのHistoryAPIというWebAPIを利用します。  
historyAPIからはページの再読み込み無しでブラウザのURL欄を変更でき、変更前のURLは戻る履歴に追加されます。  
また戻る・進む履歴からhistoryAPIで追加したURLを開いた際、ページの再読み込みは発生しません。  

これを利用し以下のような処理を実装します。

1. 画面遷移時にHistoryAPIでURLを変更。その際必要なデータを取得する為のパラメータ（開いているメールのidなど）をURLに含んでおく。  
1. URL変更時のイベントで、URLのパラメータをもとにサーバーからデータを取得する処理を実行。  

実装時はこのような動作を行うためのライブラリを利用する事が多いです。  
（react-routerなど）
  
### 検索エンジン最適化 (SEO)
読み込まれるHTMLファイルにほぼなにも記述されない為、Googleなどの検索エンジンのクローラに空のサイトと判断されてしまいます。  
その結果Googleで検索してもサイトがヒットしない、ということになってしまいます。  

一般向けのサイト（企業のホームページなど）ではこれが問題になります。  
社内で使う業務アプリのように、そもそも検索エンジンに表示される必要がないサイトの場合は気にする必要はありません。  

これに対応するためにサーバーサイドレンダリングなどの技術があります。  


## SPAの実装方法
SPAを実装する為のフレームワークを利用する事が多いです。  
著名なライブラリは以下になります。  

### react
Facebookが主体で開発しているライブラリです。  

### vue.js


### anguler


## 参考

